<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Hub App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Sacramento&display=swap'); 

        body, #root {
            height: 100vh;
            margin: 0;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
        }

        /* Glassmorphism Effect */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-nav {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
        }

        .font-verse {
            font-family: 'Sacramento', cursive; 
            font-weight: 400; 
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); 
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        
        /* Utility to hide scrollbar while keeping functionality */
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
        .hide-scroll {
            -ms-overflow-style: none; 
            scrollbar-width: none; 
        }

        /* Animation Classes */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-up {
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Safe area padding for bottom navigation */
        .pb-safe {
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Ensure the canvas element fills its container without external scroll */
        .drawing-canvas {
            touch-action: none; /* Prevents scroll/zoom on mobile when drawing */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- MOCK DATA / UTILS ---

        const THEMES = {
            royal: { bg: 'bg-slate-900', accent: 'bg-blue-600' },
            emerald: { bg: 'bg-emerald-900', accent: 'bg-emerald-600' },
            sun: { bg: 'bg-yellow-900', accent: 'bg-yellow-600' },
            ruby: { bg: 'bg-red-900', accent: 'bg-red-600' }
        };

        const MOCK_EVENTS = []; 

        const MOCK_CONTENT = [
            { type: 'verse', text: "Do everything in love, with a heart of charity and kindness towards all others.", ref: "1 Corinthians 16:14" },
            { type: 'inspo', text: "Your family is your team. Work together, love each other, and always strive to build a peaceful home.", ref: "Inspiration for today" },
            { type: 'verse', text: "A sweet friendship refreshes the soul and gives it new strength, just as the aroma of incense makes the heart cheerful.", ref: "Proverbs 27:9" },
            { type: 'inspo', text: "The most important work you will ever do will be within the walls of your own home. Invest in your loved ones daily.", ref: "Daily Guide" },
            { type: 'verse', text: "For God so loved the world that he gave His only begotten Son, that whoever believes in Him should not perish but have everlasting life.", ref: "John 3:16" },
        ];
        
        const MUSIC_URL = 'path/to/family_jingle.mp3'; // Placeholder for music file

        const getLocalISODate = (date) => date.toISOString().substring(0, 10);
        
        const getDaysInMonth = (year, month) => {
            const date = new Date(year, month, 1);
            const days = [];
            while (date.getMonth() === month) {
                days.push(new Date(date));
                date.setDate(date.getDate() + 1);
            }
            return days;
        };

        const getDailyContent = (date) => {
            const dayIndex = date.getDate() % MOCK_CONTENT.length;
            return MOCK_CONTENT[dayIndex];
        };

        // --- ICON Component (Simplified SVG Placeholder) ---
        const Icon = ({ name, active }) => {
            const color = active ? 'white' : 'white/20';
            const size = '6'; 
            
            const icons = {
                Home: <svg className={`w-${size} h-${size} text-${color}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>,
                Calendar: <svg className={`w-${size} h-${size} text-${color}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>,
                Notes: <svg className={`w-${size} h-${size} text-${color}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>,
                Settings: <svg className={`w-${size} h-${size} text-${color}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.245.54 3.125.105zM15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>,
                Music: <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55a4 4 0 102 3.45V7h4V3h-6zM10 19a2 2 0 11-4 0 2 2 0 014 0z"/></svg>,
                MusicOff: <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M4.27 3L3 4.27l9 9v.55a4 4 0 102 3.45V14.27l6.73 6.73L21 19.73 4.27 3zM10 19a2 2 0 11-4 0 2 2 0 014 0z"/></svg>,
                Play: <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18V6l12 6-12 6z"/></svg>,
                Pause: <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>,
                Back: <svg className={`w-3 h-3 mr-1 text-${color}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>,
                Mic: <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-2c0 3.97-3.33 7.1-7.3 7.1S4.7 15.97 4.7 12H3c0 4.84 3.96 8.8 8.8 8.9V24h2.4v-3.1c4.84-.1 8.8-4.06 8.8-8.9h-1.7z"/></svg>
            };
            
            return icons[name] || <div className={`w-${size} h-${size} bg-red-500 rounded`}></div>; 
        };

        // --- AVATAR Component (Simplified) ---
        const Avatar = ({ type }) => {
            const icons = {
                dad: <span className="text-3xl">üë®üèª</span>,
                mom: <span className="text-3xl">üë©üèº</span>,
                boy: <span className="text-3xl">üë¶üèΩ</span>,
                girl: <span className="text-3xl">üëßüèª</span>,
                default: <span className="text-3xl">üë§</span>
            };
            return icons[type] || icons.default;
        };
        
        // --- DrawPad Component (SIMPLIFIED for debugging) ---
        const DRAWING_COLORS = ['#FFFFFF', '#FF0000', '#000000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF'];
        const DrawPad = ({ onSaveDrawing, currentUser }) => {
            const canvasRef = useRef(null);
            const [tool, setTool] = useState('pen'); 
            const [color, setColor] = useState(DRAWING_COLORS[0]);
            const [isDrawing, setIsDrawing] = useState(false);
            
            const ctxRef = useRef(null);

            const getCanvasContext = () => {
                if (canvasRef.current && !ctxRef.current) {
                    ctxRef.current = canvasRef.current.getContext('2d');
                }
                return ctxRef.current;
            };

            const setupCanvas = () => {
                const canvas = canvasRef.current;
                if (!canvas || !canvas.parentElement) return;
                
                const containerRect = canvas.parentElement.getBoundingClientRect();
                canvas.width = containerRect.width;
                canvas.height = containerRect.height;
                
                const ctx = getCanvasContext();
                if (ctx) {
                    ctx.fillStyle = "rgba(255, 255, 255, 0.05)";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            };

            useEffect(() => {
                if (canvasRef.current) {
                    setupCanvas();
                }
            }, [canvasRef.current]); 

            const getMousePos = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                
                if (clientX === undefined || clientY === undefined) return null;

                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            };
            
            const startDraw = (e) => {
                e.preventDefault(); 
                const ctx = getCanvasContext();
                const pos = getMousePos(e);
                if (!ctx || !pos) return;

                setIsDrawing(true);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            };
            
            const draw = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const ctx = getCanvasContext();
                const pos = getMousePos(e);
                if (!ctx || !pos) return;
                
                ctx.strokeStyle = color;
                ctx.lineWidth = 5;
                ctx.lineCap = "round";

                if (tool === 'pen') {
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();
                }
                // Removed complex shape drawing logic for debugging
            };

            const endDraw = () => {
                if (!isDrawing) return;
                setIsDrawing(false);
            };
            
            const handleClear = () => {
                const ctx = getCanvasContext();
                if(ctx && canvasRef.current) {
                    ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
                    setupCanvas(); 
                }
            }
            
            const handleSave = () => {
                if (!canvasRef.current || !currentUser) return;

                const imageDataUrl = canvasRef.current.toDataURL('image/png');
                onSaveDrawing(prev => [{
                    id: Date.now(),
                    type: 'draw',
                    content: imageDataUrl,
                    owner: currentUser.name,
                    timestamp: new Date().toISOString()
                }, ...prev]);
                handleClear(); 
                alert("Drawing Saved!");
            }

            return (
                <div className="glass rounded-[2rem] p-6">
                    <div className="flex justify-around items-center mb-4 p-2 glass rounded-xl text-white/80">
                        {/* Color Picker */}
                        <div className="flex gap-2">
                            {DRAWING_COLORS.map(c => (
                                <button key={c} onClick={() => setColor(c)} className={`w-6 h-6 rounded-full border-2 transition-all ${color === c ? 'scale-110 border-white' : 'border-transparent'}`} style={{backgroundColor: c}}></button>
                            ))}
                        </div>
                        
                        {/* Tool Selector - Only Pen remains */}
                        <div className="flex gap-2 text-white">
                            <button onClick={() => setTool('pen')} className={`p-2 rounded-lg transition-all ${tool === 'pen' ? 'bg-blue-600/50' : 'bg-white/10'}`}>
                                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M14 20.25v-3.875l4.5-4.5 3.5 3.5-4.5 4.5h-3.5zm3.5-5l-4.5 4.5-3.5-3.5 4.5-4.5 3.5 3.5zM3 17.25l1.5 1.5-1.5 1.5v-3z"/></svg>
                            </button>
                        </div>
                    </div>
                    
                    {/* The Canvas Element Container */}
                    <div className="w-full h-64 mb-4">
                        <canvas 
                            ref={canvasRef} 
                            className="w-full h-full bg-white/5 rounded-xl border border-white/10 cursor-crosshair drawing-canvas"
                            onMouseDown={startDraw}
                            onMouseMove={draw}
                            onMouseUp={endDraw}
                            onMouseLeave={endDraw} 
                            onTouchStart={startDraw}
                            onTouchMove={draw}
                            onTouchEnd={endDraw}
                        ></canvas>
                    </div>
                    
                    <div className="flex justify-between items-center">
                        <button onClick={handleClear} className="px-4 py-2 rounded-lg font-bold text-xs bg-red-600/50 text-white/70 hover:bg-red-700 transition">Clear</button>
                        <button className={`px-4 py-2 rounded-lg font-bold text-xs ${THEMES.royal.accent} hover:bg-blue-700 transition`} onClick={handleSave}>Save Drawing</button>
                    </div>
                </div>
            )
        }


        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [view, setView] = useState('auth'); 
            const [tab, setTab] = useState('home'); 
            
            // Family/User State
            const [family, setFamily] = useState({ name: '', members: [] });
            const [currentUser, setCurrentUser] = useState(null);
            const currentTheme = currentUser ? THEMES[currentUser.theme] : THEMES.royal;
            
            // Auth View State
            const [newMemName, setNewMemName] = useState('');
            const [newMemRole, setNewMemRole] = useState('dad'); 
            
            // Calendar View State
            const [events, setEvents] = useState(MOCK_EVENTS); 
            const [calendarView, setCalendarView] = useState('grid'); 
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [currentCalendarDate, setCurrentCalendarDate] = useState(new Date());
            const [dashboardDate, setDashboardDate] = useState(new Date());
            const [eventTime, setEventTime] = useState(new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}).substring(0,5));
            const [inputTitle, setInputTitle] = useState('');
            
            // Notes View State
            const [noteMode, setNoteMode] = useState('type'); 
            const [noteText, setNoteText] = useState('');
            const [isListening, setIsListening] = useState(false);
            const [savedNotes, setSavedNotes] = useState([]); 

            // Media/Audio State
            const audioRef = useRef(null);
            const [music, setMusic] = useState(false);
            const [isPlayingVerse, setIsPlayingVerse] = useState(false);

            // --- EFFECTS ---

            // Handle music play/pause
            useEffect(() => {
                if (audioRef.current) {
                    if (music) {
                        audioRef.current.play();
                    } else {
                        audioRef.current.pause();
                    }
                }
            }, [music]);
            
            const toggleVerse = (content) => {
                if(isPlayingVerse) {
                    window.speechSynthesis.cancel();
                    setIsPlayingVerse(false);
                } else {
                    const [bookChapter, verseNumber] = content.ref.split(':');
                    const spokenReference = `${bookChapter.replace(/(\d+)/g, ' $1,')}, verse ${verseNumber}`;
                    const spokenText = `${content.text}. ${spokenReference}`;
                    
                    const utterance = new SpeechSynthesisUtterance(spokenText);
                    utterance.rate = 0.9; 
                    utterance.onend = () => setIsPlayingVerse(false);
                    window.speechSynthesis.speak(utterance);
                    setIsPlayingVerse(true);
                }
            };
            
            // Text-to-Speech for Saved Notes
            const readNoteAloud = (text) => {
                 if(window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                }
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.0; 
                window.speechSynthesis.speak(utterance);
            }

            // --- HANDLERS ---
            
            const handleSwitchUser = (member) => {
                setCurrentUser(member);
                setTab('home'); 
            }

            const handleUpdateTheme = (themeKey) => {
                const updatedMembers = family.members.map(m => 
                    m.name === currentUser.name ? { ...m, theme: themeKey } : m
                );
                setFamily({...family, members: updatedMembers});
                setCurrentUser({...currentUser, theme: themeKey});
            }
            
            const handleUpdatePref = (pref) => {
                const updatedMembers = family.members.map(m => 
                    m.name === currentUser.name ? { ...m, pref: pref } : m
                );
                setFamily({...family, members: updatedMembers});
                setCurrentUser({...currentUser, pref: pref});
            }

            // --- CALENDAR LOGIC ---

            const changeCalendarMonth = (direction) => {
                setCurrentMonth(prev => {
                    const newMonth = new Date(prev.getFullYear(), prev.getMonth() + direction, 1);
                    return newMonth;
                });
            }
            
            const changeDashboardDate = (direction) => {
                setDashboardDate(prev => {
                    const newDate = new Date(prev);
                    newDate.setDate(newDate.getDate() + direction);
                    return newDate;
                });
            }

            const getDashboardDateString = () => {
                const today = getLocalISODate(new Date());
                const dashDay = getLocalISODate(dashboardDate);
                
                if (today === dashDay) return "TODAY'S ACTIVITY";
                
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (getLocalISODate(yesterday) === dashDay) return "YESTERDAY'S ACTIVITY";
                
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                if (getLocalISODate(tomorrow) === dashDay) return "TOMORROW'S ACTIVITY";

                return dashboardDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }).toUpperCase();
            }

            const getDashboardEvents = () => {
                const dateStr = getLocalISODate(dashboardDate);
                const validMemberNames = family.members.map(m => m.name);
                
                return events.filter(e => 
                                 getLocalISODate(new Date(e.date)) === dateStr &&
                                 validMemberNames.includes(e.owner)
                               )
                             .sort((a,b) => new Date(a.date) - new Date(b.date));
            }
            
            const getEventsForSelectedDay = useMemo(() => {
                if (!currentUser) return [];
                const dateStr = getLocalISODate(currentCalendarDate);
                return events.filter(e => e.owner === currentUser.name && getLocalISODate(new Date(e.date)) === dateStr)
                             .sort((a,b) => new Date(a.date) - new Date(b.date));
            }, [events, currentUser, currentCalendarDate]);


            const handleSaveEvent = () => {
                if (!currentUser) return alert("Please select a user first."); 
                if (!inputTitle || !eventTime) {
                    return alert("Please enter both a title and a time.");
                }

                const datePart = currentCalendarDate.toISOString().substring(0, 10); 
                
                const localDateTimeString = `${datePart} ${eventTime}`;
                const eventDateObject = new Date(localDateTimeString);
                const dateTimeISO = eventDateObject.toISOString();

                const newEvent = {
                    id: Date.now(), 
                    title: inputTitle,
                    date: dateTimeISO,
                    owner: currentUser.name 
                };

                setEvents(prev => [...prev, newEvent]);
                setInputTitle('');
            }
            
            // --- VOICE INPUT (COMMON) ---
            const handleVoiceInput = (setter) => {
                if (!window.webkitSpeechRecognition) {
                    return alert("Voice input requires a browser that supports Webkit Speech Recognition (like Chrome).");
                }
                
                if (isListening) {
                    window.speechSynthesis.cancel(); 
                    setIsListening(false);
                    return;
                }

                const recognition = new window.webkitSpeechRecognition();
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.continuous = false; 

                recognition.onstart = () => {
                    setIsListening(true);
                    if(setter === setInputTitle) setInputTitle("... Listening ...");
                    if(setter === setNoteText) setNoteText(prev => prev + '... Listening ...');
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    if(setter === setInputTitle) {
                        setInputTitle(transcript);
                    } else if (setter === setNoteText) {
                        setNoteText(prev => prev.replace('... Listening ...', '').trim() + ' ' + transcript);
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    if(setter === setInputTitle) setInputTitle(prev => prev === "... Listening ..." ? "" : prev);
                    if(setter === setNoteText) setNoteText(prev => prev.replace('... Listening ...', '').trim());
                    alert("Voice input failed. Try again.");
                    setIsListening(false);
                };

                recognition.onend = () => {
                    if(setter === setInputTitle) setInputTitle(prev => prev === "... Listening ..." ? "" : prev);
                    if(setter === setNoteText) setNoteText(prev => prev.replace('... Listening ...', '').trim());
                    setIsListening(false);
                };

                recognition.start();
            };
            
            // --- NOTES LOGIC ---
            const handleSaveNote = () => {
                if (!currentUser || !noteText.trim()) return alert("Note is empty or no user selected.");
                
                const newNote = {
                    id: Date.now(),
                    type: 'text',
                    content: noteText.trim(),
                    owner: currentUser.name,
                    timestamp: new Date().toISOString()
                };

                setSavedNotes(prev => [newNote, ...prev]);
                setNoteText('');
                alert("Note Saved!");
            }
            
            const getSavedNotesForUser = useMemo(() => {
                if (!currentUser) return [];
                return savedNotes.filter(n => n.owner === currentUser.name)
                                 .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            }, [savedNotes, currentUser]);


            // The daily content for the Home tab is based on the current user's preference
            const dailyHomeContent = useMemo(() => {
                const today = new Date();
                const allContent = MOCK_CONTENT.map((c, i) => getDailyContent(new Date(today.getFullYear(), today.getMonth(), today.getDate() + i)));

                const preference = currentUser?.pref || 'both';

                if (preference === 'verse') {
                    const verse = allContent.find(c => c.type === 'verse');
                    return verse || allContent[0];
                }
                if (preference === 'inspo') {
                    const inspo = allContent.find(c => c.type === 'inspo');
                    return inspo || allContent[0];
                }
                
                return allContent[0];
            }, [currentUser]);


            // --- RENDER LOGIC ---

            if (view === 'auth') {
                return (
                    <div className={`h-full flex flex-col items-center justify-center p-8 bg-slate-950 text-white`}>
                        <div className="glass p-8 rounded-[2.5rem] w-full max-w-sm">
                            <h1 className="text-3xl font-extrabold mb-2 text-center">Family Hub</h1>
                            <p className="text-white/50 mb-8 text-sm text-center">Setup your family space</p>
                            <input id="famName" placeholder="Family Name (e.g. Ebot)" className="w-full bg-white/5 border border-white/10 rounded-xl p-4 text-white text-center placeholder-white/30 mb-6 outline-none"/>
                            
                            <div className="mb-4">
                                <label className="text-xs font-bold text-white/50 uppercase block mb-2">Select Role</label>
                                <div className="grid grid-cols-4 gap-2">
                                    {['dad','mom','boy','girl'].map(r => (
                                        <button key={r} onClick={()=>setNewMemRole(r)} className={`p-2 rounded-xl flex flex-col items-center gap-1 transition-all ${newMemRole===r ? 'bg-blue-600/30 border border-blue-400' : 'bg-white/5 border border-transparent'}`}>
                                            <div className="w-8 h-8 flex items-center justify-center"><Avatar type={r}/></div>
                                            <span className="text-[9px] uppercase font-bold text-white/70">{r}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="flex gap-2 mb-6">
                                <input value={newMemName} onChange={e=>setNewMemName(e.target.value)} placeholder="Member Name" className="flex-1 bg-white/5 border border-white/10 rounded-xl p-3 text-white outline-none"/>
                                <button onClick={()=>{
                                    if(newMemName && family.members.length < 6) {
                                        setFamily({...family, members: [...family.members, {name: newMemName, role: newMemRole, theme: 'royal', pref: 'both'}]});
                                        setNewMemName('');
                                    }
                                }} className="bg-white/10 border border-white/20 p-3 rounded-xl font-bold text-xl hover:bg-white/20 transition">+</button>
                            </div>

                            <div className="flex gap-2 justify-center mb-8 flex-wrap min-h-[30px]">
                                {family.members.map((m,i)=><div key={i} className="text-xs bg-white/20 px-3 py-1 rounded-full font-bold">{m.name}</div>)}
                            </div>

                            <button onClick={()=>{
                                const n = document.getElementById('famName').value || "Ebot";
                                if(family.members.length===0) return alert("Add at least 1 member");
                                const finalFam = {...family, name: n};
                                setCurrentUser(finalFam.members[0]);
                                setView('license');
                            }} className={`w-full py-4 text-white font-bold rounded-2xl bg-blue-600 shadow-lg shadow-blue-500/20`}>Next Step</button>
                        </div>
                    </div>
                );
            }

            if (view === 'license') {
                return (
                    <div className={`h-full flex items-center justify-center p-8 bg-black`}>
                        <div className="glass p-8 rounded-[2.5rem] w-full max-w-sm text-center">
                            <div className="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">üîí</div>
                            <h2 className="text-xl font-bold text-white mb-2">Security Check</h2>
                            <p className="text-white/40 text-xs mb-6">Key: FAMILY-1234</p>
                            <input id="lic" placeholder="XXXX-XXXX" className="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-center text-white tracking-widest uppercase mb-6 outline-none"/>
                            <button 
                                onClick={async () => {
                                    const licenseKey = document.getElementById('lic').value;
                                    const isValid = licenseKey === 'FAMILY-1234'; 
                                    
                                    if (isValid) {
                                        setView('app');
                                    } else {
                                        alert('Invalid License Key.');
                                    }
                                }} 
                                className="w-full py-4 bg-white text-black font-bold rounded-2xl"
                            >
                                Unlock
                            </button>
                        </div>
                    </div>
                );
            }

            // 3. MAIN APP
            return (
                <div className={`h-full flex flex-col ${currentTheme.bg} transition-colors duration-700`}> 
                    <audio ref={audioRef} src={MUSIC_URL} loop muted={!music} volume={music ? 0.5 : 0} />

                    {/* Main content area */}
                    <main className="flex-1 overflow-y-auto pb-28"> 
                        
                        {/* --- HOME TAB --- */}
                        {tab === 'home' && (
                            <div className="fade-in flex flex-col"> 
                                <div className="pt-6 px-6 pb-2">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h1 className="text-2xl font-extrabold text-white">Welcome The {family.name}s</h1>
                                            <p className="text-xs font-bold text-white/60 uppercase tracking-[0.1em] mt-1">{currentUser.name}'s Space</p>
                                        </div>
                                        <button onClick={()=>setMusic(!music)} className={`p-3 rounded-full glass transition ${music?'text-emerald-400':'text-white/30'}`}>
                                            <Icon name={music?'Music':'MusicOff'} active={music}/>
                                        </button>
                                    </div>

                                    <div className="flex gap-4 overflow-x-auto hide-scroll pb-2 mb-2 px-1">
                                        {family.members.map((m,i) => (
                                            <button key={i} onClick={()=>handleSwitchUser(m)} className="flex flex-col items-center gap-1 min-w-[60px] group">
                                                <div className={`w-14 h-14 rounded-full flex items-center justify-center transition-all ${currentUser.name===m.name ? 'bg-white scale-110 shadow-lg' : 'glass group-hover:bg-white/20'}`}>
                                                    <div className="w-10 h-10 flex items-center justify-center"><Avatar type={m.role} /></div>
                                                </div>
                                                <span className={`text-[10px] font-bold uppercase tracking-widest ${currentUser.name===m.name ? 'text-white' : 'text-white/50'}`}>{m.name.substring(0,6)}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div className="mx-6 h-px bg-gradient-to-r from-transparent via-white/20 to-transparent my-1"></div>

                                <div className="px-6 py-4 text-center flex-shrink-0">
                                    <p className="font-verse text-4xl text-white leading-relaxed italic mb-2">
                                        "{dailyHomeContent.text}"
                                    </p>
                                    
                                    <div className="flex flex-col items-center justify-center gap-2 mt-1">
                                        <button onClick={()=>toggleVerse(dailyHomeContent)} className="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center backdrop-blur-md transition">
                                            <Icon name={isPlayingVerse ? 'Pause' : 'Play'} />
                                        </button>
                                        <span className="font-bold text-xs text-white/60 tracking-wider">
                                            {dailyHomeContent.type === 'inspo' ? "Let this word motivate and guide you today." : dailyHomeContent.ref}
                                        </span>
                                    </div>
                                </div>

                                <div className="px-6 mt-2">
                                    <div className="glass rounded-[2rem] overflow-hidden p-6"> 
                                        
                                        <div className="flex justify-between items-center border-b border-white/10 pb-3 mb-3">
                                            <button onClick={()=>changeDashboardDate(-1)} className="text-xl font-bold p-1 text-white/50 hover:text-white transition">
                                                &lt;
                                            </button>
                                            <div className="flex flex-col items-center">
                                                <h2 className="text-xl font-extrabold tracking-widest text-white">FAMILY DASHBOARD</h2>
                                                <span className="text-[10px] text-white/50 font-bold uppercase tracking-widest mt-1">{getDashboardDateString()}</span>
                                            </div>
                                            <button onClick={()=>changeDashboardDate(1)} className="text-xl font-bold p-1 text-white/50 hover:text-white transition">
                                                &gt;
                                            </button>
                                        </div>
                                        
                                        <div className="space-y-3"> 
                                            {getDashboardEvents().length === 0 ? (
                                                <div className="py-6 text-center text-white/40 text-sm italic">No scheduled activity.</div>
                                            ) : (
                                                getDashboardEvents().map(e => (
                                                    <div key={e.id} className="p-3 rounded-xl bg-white/5 flex items-center gap-3">
                                                        <div className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center">
                                                            <div className="text-lg"><Avatar type={family.members.find(m => m.name === e.owner)?.role || 'default'} /></div>
                                                        </div>
                                                        <div className="flex-1">
                                                            <div className="flex justify-between items-center">
                                                                <span className="font-bold text-white text-sm">{e.title}</span>
                                                                <span className="font-mono text-white/60 text-xs bg-black/20 px-2 py-1 rounded">{new Date(e.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
                                                            </div>
                                                            <span className="text-[9px] text-white/40 uppercase tracking-wider">{e.owner}</span>
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                    <div className="h-4"></div> 
                                </div>
                            </div>
                        )}

                        {/* --- CALENDAR TAB --- */}
                        {tab === 'calendar' && (
                            <div className="pt-10 px-6 fade-in h-full">
                                <h2 className="text-3xl font-bold mb-6">Plan Calendar</h2>

                                {/* CALENDAR GRID VIEW */}
                                {calendarView === 'grid' && (
                                    <div className="glass rounded-[2rem] p-4 slide-up">
                                        <div className="flex justify-between items-center mb-4">
                                            <button onClick={()=>changeCalendarMonth(-1)} className="text-xl font-bold p-1 text-white/50 hover:text-white transition">
                                                &lt;
                                            </button>
                                            <h3 className="text-xl font-extrabold text-white">
                                                {currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                                            </h3>
                                            <button onClick={()=>changeCalendarMonth(1)} className="text-xl font-bold p-1 text-white/50 hover:text-white transition">
                                                &gt;
                                            </button>
                                        </div>

                                        <div className="calendar-grid text-center text-xs font-bold uppercase mb-2">
                                            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
                                                <div key={d} className="text-white/50">{d}</div>
                                            ))}
                                        </div>
                                        <div className="calendar-grid">
                                            {(() => {
                                                const daysInMonth = getDaysInMonth(currentMonth.getFullYear(), currentMonth.getMonth());
                                                const firstDay = daysInMonth[0].getDay(); 
                                                const todayStr = getLocalISODate(new Date()); 
                                                
                                                const blanks = Array(firstDay).fill(null);
                                                
                                                return [...blanks, ...daysInMonth].map((day, index) => {
                                                    if (day === null) return <div key={`blank-${index}`} className="p-2"></div>;

                                                    const dayStr = getLocalISODate(day); 
                                                    const isToday = dayStr === todayStr;
                                                    const dayEvents = events.filter(e => e.owner === currentUser?.name && getLocalISODate(new Date(e.date)) === dayStr); 

                                                    return (
                                                        <button 
                                                            key={dayStr}
                                                            onClick={() => {
                                                                setCurrentCalendarDate(day);
                                                                setCalendarView('dayDetail');
                                                            }}
                                                            className={`p-1 rounded-lg transition text-sm font-bold flex flex-col items-center justify-center relative min-h-[40px] ${
                                                                isToday ? 'bg-white/10 text-white border border-white/30' : 
                                                                'hover:bg-white/10 text-white/80'
                                                            }`}
                                                        >
                                                            {day.getDate()}
                                                            {dayEvents.length > 0 && (
                                                                <div className="absolute bottom-1 right-1 w-2 h-2 rounded-full bg-red-400"></div>
                                                            )}
                                                        </button>
                                                    );
                                                });
                                            })()}
                                        </div>
                                    </div>
                                )}
                                
                                {/* DAY DETAIL / EVENT ENTRY VIEW */}
                                {calendarView === 'dayDetail' && (
                                    <div className="glass rounded-[2rem] p-6 slide-up min-h-full">
                                        <div className="flex justify-between items-center mb-4">
                                            <button onClick={()=>setCalendarView('grid')} className="text-white/70 hover:text-white transition flex items-center font-bold text-xs uppercase tracking-widest">
                                                <Icon name="Back" active={true} /> Back to Month
                                            </button>
                                            <h3 className="text-white text-md font-bold">
                                                {currentCalendarDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}
                                            </h3>
                                        </div>

                                        <div className="p-3 rounded-xl bg-white/5 mb-4 text-center">
                                            <p className="font-verse text-xl italic text-white/80"> 
                                                "{getDailyContent(currentCalendarDate).text}"
                                            </p>
                                            <span className="text-[9px] text-white/40 uppercase font-bold tracking-wider">
                                                {getDailyContent(currentCalendarDate).type === 'inspo' ? "Daily Motivation" : getDailyContent(currentCalendarDate).ref}
                                            </span>
                                        </div>

                                        <h4 className="text-white/50 text-xs font-bold uppercase mb-2">Add Event for {currentUser.name}</h4>
                                        
                                        <div className="flex gap-2 mb-4">
                                            <input 
                                                type="time" 
                                                value={eventTime} 
                                                onChange={e => setEventTime(e.target.value)} 
                                                className="bg-white/10 border border-white/10 rounded-xl p-3 text-white outline-none w-28 text-center"
                                            />
                                            <input 
                                                value={inputTitle} 
                                                onChange={e => setInputTitle(e.target.value)} 
                                                placeholder="Event Title" 
                                                className="flex-1 bg-white/10 border border-white/10 rounded-xl p-3 text-white outline-none"
                                                disabled={isListening}
                                            />
                                            <button 
                                                onClick={()=>handleVoiceInput(setInputTitle)} 
                                                className={`w-12 h-12 rounded-xl flex items-center justify-center transition-all ${isListening && inputTitle.includes('Listening') ? 'bg-red-500/50' : 'bg-white/10 hover:bg-white/20'}`}
                                            >
                                                <Icon name="Mic" active={!(isListening && inputTitle.includes('Listening'))} />
                                            </button>
                                        </div>
                                        <button 
                                            onClick={handleSaveEvent} 
                                            className={`w-full py-3 font-bold rounded-xl text-white ${currentTheme.accent}`}
                                        >
                                            Save Event
                                        </button>

                                        <h4 className="text-white/50 text-xs font-bold uppercase mt-6 mb-2">{currentUser.name}'s Events on this day</h4>
                                        <div className="space-y-2">
                                            {getEventsForSelectedDay.length === 0 ? (
                                                <p className="text-white/40 text-sm italic">No scheduled events for {currentUser.name}.</p>
                                            ) : (
                                                getEventsForSelectedDay.map(e => (
                                                    <div key={e.id} className="p-3 rounded-xl bg-black/10 flex justify-between items-center">
                                                        <span className="font-bold text-white text-sm">{e.title}</span>
                                                        <span className="font-mono text-white/60 text-xs bg-black/20 px-2 py-1 rounded">
                                                            {new Date(e.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
                                                        </span>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {/* --- NOTES TAB (WITH FIXED DRAW PAD) --- */}
                        {tab === 'notes' && (
                            <div className="pt-10 px-6 fade-in">
                                <h2 className="text-3xl font-bold mb-6">Creative Studio</h2>
                                
                                <div className="glass p-1 rounded-xl flex mb-6">
                                    <button onClick={()=>setNoteMode('type')} className={`flex-1 py-3 rounded-lg text-xs font-bold uppercase transition ${noteMode==='type'?'bg-white/20 text-white':'text-white/40'}`}>Type & Voice</button>
                                    <button onClick={()=>setNoteMode('draw')} className={`flex-1 py-3 rounded-lg text-xs font-bold uppercase transition ${noteMode==='draw'?'bg-white/20 text-white':'text-white/40'}`}>Draw Pad</button>
                                </div>

                                {/* Text/Voice Note Area */}
                                {noteMode === 'type' ? (
                                    <div className="glass rounded-[2rem] p-6 slide-up">
                                        <textarea value={noteText} onChange={e=>setNoteText(e.target.value)} className="w-full h-32 bg-transparent text-white placeholder-white/30 outline-none resize-none mb-4" placeholder={`Type a note for ${currentUser.name}...`}></textarea>
                                        <div className="flex justify-between items-center">
                                            <button onClick={()=>handleVoiceInput(setNoteText)} className={`p-3 rounded-full transition-all ${isListening && noteText.includes('Listening') ? 'bg-red-500/50' : 'bg-white/10 hover:bg-white/20'}`}>
                                                <Icon name="Mic" active={!(isListening && noteText.includes('Listening'))}/>
                                            </button>
                                            <button className={`px-4 py-2 rounded-lg font-bold text-xs ${currentTheme.accent} hover:opacity-80 transition`} onClick={handleSaveNote}>Save Note</button>
                                        </div>
                                    </div>
                                ) : (
                                    // Draw Pad Area (Uses functional component)
                                    <DrawPad onSaveDrawing={setSavedNotes} currentUser={currentUser} />
                                )}

                                {/* Saved Notes Section */}
                                <div className="mt-8 mb-6">
                                    <h4 className="text-white/50 text-sm font-bold uppercase mb-4 tracking-widest">SAVED NOTES ({currentUser.name})</h4>
                                    
                                    <div className="space-y-4">
                                        {getSavedNotesForUser.length === 0 ? (
                                            <p className="text-white/40 text-sm italic py-4 text-center">No saved notes or drawings yet.</p>
                                        ) : (
                                            getSavedNotesForUser.map(note => (
                                                <div key={note.id} className="p-4 rounded-xl glass flex flex-col">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <span className="text-white/60 text-[10px] uppercase font-bold">
                                                            {note.type === 'text' ? 'Text Note' : 'Drawing'} - {new Date(note.timestamp).toLocaleDateString()}
                                                        </span>
                                                        {note.type === 'text' && (
                                                            <button onClick={() => readNoteAloud(note.content)} className="p-2 rounded-full bg-white/10 text-white hover:bg-white/20 transition">
                                                                <Icon name="Play" />
                                                            </button>
                                                        )}
                                                    </div>
                                                    
                                                    {note.type === 'text' ? (
                                                        <p className="text-white text-sm whitespace-pre-wrap">{note.content}</p>
                                                    ) : (
                                                        <img src={note.content} alt="Saved Drawing" className="w-full rounded-lg border border-white/10 max-h-40 object-contain"/>
                                                    )}
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- SETTINGS TAB --- */}
                        {tab === 'settings' && (
                            <div className="pt-10 px-6 fade-in">
                                <h2 className="text-3xl font-bold mb-2">Settings</h2>
                                <p className="text-sm text-white/50 mb-8">Personalize {currentUser.name}'s Experience</p>
                                
                                <div className="space-y-8">
                                    <div>
                                        <h3 className="text-white/50 text-xs font-bold uppercase mb-3">Color Theme</h3>
                                        <div className="grid grid-cols-4 gap-3">
                                            {Object.entries(THEMES).map(([k, t]) => (
                                                <button key={k} onClick={()=>handleUpdateTheme(k)} className={`w-14 h-14 rounded-2xl ${t.bg} border-2 shadow-lg ${currentUser.theme===k?'border-white scale-110':'border-transparent opacity-60'}`}></button>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <h3 className="text-white/50 text-xs font-bold uppercase mb-3">Content Preference</h3>
                                        <div className="glass p-1 rounded-xl flex">
                                            {['verse','inspo','both'].map(p => (
                                                <button key={p} onClick={()=>handleUpdatePref(p)} className={`flex-1 py-3 rounded-lg text-xs font-bold uppercase transition ${currentUser.pref===p?'bg-white/20 text-white':'text-white/40'}`}>{p}</button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* NAV BAR */}
                    <div className="fixed bottom-0 w-full glass-nav px-2 pb-safe pt-2 z-50">
                        <div className="flex justify-between items-end">
                            {['home','calendar','notes','settings'].map(t => (
                                <button key={t} onClick={()=>setTab(t)} className="flex flex-col items-center p-3 w-1/4 group">
                                    <div className={`transition-transform duration-300 ${tab===t ? '-translate-y-1' : ''}`}>
                                        <Icon name={t.charAt(0).toUpperCase() + t.slice(1)} active={tab===t} />
                                    </div>
                                    <span className={`text-[9px] font-bold mt-1 transition-colors ${tab===t?'text-white':'text-white/20'}`}>{t.toUpperCase()}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
